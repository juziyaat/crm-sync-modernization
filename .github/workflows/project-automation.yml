name: Project Automation

on:
  issues:
    types: [opened, labeled, closed, reopened]
  pull_request:
    types: [opened, ready_for_review, review_requested, closed]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Label AI tasks
        if: contains(github.event.issue.title, 'AI') || contains(github.event.issue.body, 'AI Task')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['ai-task']
            });

      - name: Label by phase
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const body = context.payload.issue.body?.toLowerCase() || '';
            const labels = [];

            // Auto-detect phase from title or body
            if (title.includes('foundation') || body.includes('phase-1')) {
              labels.push('phase-1-foundation');
            } else if (title.includes('domain') || body.includes('phase-2')) {
              labels.push('phase-2-domain');
            } else if (title.includes('multi-tenant') || body.includes('phase-3')) {
              labels.push('phase-3-multi-tenancy');
            } else if (title.includes('cqrs') || body.includes('phase-4')) {
              labels.push('phase-4-cqrs');
            } else if (title.includes('api') || body.includes('phase-5')) {
              labels.push('phase-5-api');
            }

            // Auto-detect technology area
            if (title.includes('domain') || body.includes('domain layer')) {
              labels.push('domain');
            } else if (title.includes('application') || body.includes('application layer')) {
              labels.push('application');
            } else if (title.includes('infrastructure') || body.includes('database')) {
              labels.push('infrastructure');
            } else if (title.includes('api') || title.includes('endpoint')) {
              labels.push('api');
            } else if (title.includes('test')) {
              labels.push('testing');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }

  link-pr-to-issue:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Extract issue numbers from PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const issueNumbers = [];

            // Match "Closes #123", "Fixes #123", "Resolves #123"
            const regex = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#(\d+)/gi;
            let match;

            while ((match = regex.exec(body)) !== null) {
              issueNumbers.push(match[1]);
            }

            // Comment on linked issues
            for (const issueNum of issueNumbers) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNum),
                body: `ðŸ¤– PR #${context.issue.number} has been created to address this issue.\n\n` +
                      `**Status**: Ready for review\n` +
                      `**Assignee**: AI Implementation\n\n` +
                      `[View Pull Request](${context.payload.pull_request.html_url})`
              });

              // Add "ready-for-review" label to issue
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNum),
                labels: ['ready-for-review']
              });
            }

  pr-ready-notification:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'review_requested'
    steps:
      - name: Notify reviewer
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸ‘€ **Human review requested**\n\n` +
                    `This PR is ready for review. Please check:\n` +
                    `- âœ… Business logic correctness\n` +
                    `- âœ… Domain model integrity\n` +
                    `- âœ… Test coverage adequacy\n` +
                    `- âœ… Edge case handling\n` +
                    `- âœ… Error message clarity\n\n` +
                    `Reviewers: ${context.payload.pull_request.requested_reviewers.map(r => '@' + r.login).join(', ')}`
            });

  close-issue-on-merge:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const issueNumbers = [];

            // Match "Closes #123", "Fixes #123", "Resolves #123"
            const regex = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#(\d+)/gi;
            let match;

            while ((match = regex.exec(body)) !== null) {
              issueNumbers.push(match[1]);
            }

            // Close and comment on linked issues
            for (const issueNum of issueNumbers) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNum),
                body: `âœ… **Completed!**\n\n` +
                      `This issue was resolved by PR #${context.issue.number}\n\n` +
                      `Merged by: @${context.payload.pull_request.merged_by.login}\n` +
                      `Merged at: ${new Date().toISOString()}`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNum),
                state: 'closed'
              });
            }

  add-metrics-comment:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Calculate and post metrics
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const createdAt = new Date(pr.created_at);
            const mergedAt = new Date(pr.merged_at);
            const timeToMerge = Math.round((mergedAt - createdAt) / (1000 * 60)); // minutes

            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const linesAdded = files.reduce((sum, file) => sum + file.additions, 0);
            const linesRemoved = files.reduce((sum, file) => sum + file.deletions, 0);
            const filesChanged = files.length;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸ“Š **PR Metrics**\n\n` +
                    `â±ï¸ Time to merge: ${timeToMerge} minutes\n` +
                    `ðŸ“ Files changed: ${filesChanged}\n` +
                    `âž• Lines added: ${linesAdded}\n` +
                    `âž– Lines removed: ${linesRemoved}\n` +
                    `ðŸ‘¥ Reviews: ${reviews.length}\n` +
                    `ðŸ·ï¸ Labels: ${pr.labels.map(l => l.name).join(', ')}`
            });
