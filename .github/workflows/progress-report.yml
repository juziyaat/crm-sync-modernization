name: Daily Progress Report

on:
  schedule:
    - cron: '0 17 * * *'  # 5 PM UTC daily (9 AM PST)
  workflow_dispatch:  # Allow manual trigger

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Progress Report
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date();
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);

            // Get all issues updated in last 24 hours
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: yesterday.toISOString(),
              per_page: 100
            });

            // Filter and categorize
            const created = allIssues.filter(i =>
              new Date(i.created_at) > yesterday && !i.pull_request
            );
            const completed = allIssues.filter(i =>
              i.state === 'closed' &&
              new Date(i.closed_at) > yesterday &&
              !i.pull_request
            );
            const inProgress = allIssues.filter(i =>
              i.state === 'open' &&
              i.labels.some(l => l.name === 'in-progress') &&
              !i.pull_request
            );

            // Get PRs from last 24 hours
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'updated',
              direction: 'desc',
              per_page: 50
            });

            const prsMerged = prs.filter(pr =>
              pr.merged_at && new Date(pr.merged_at) > yesterday
            );
            const prsCreated = prs.filter(pr =>
              new Date(pr.created_at) > yesterday
            );

            // Calculate phase progress
            const phaseStats = {};
            const phases = [
              'phase-1-foundation',
              'phase-2-domain',
              'phase-3-multi-tenancy',
              'phase-4-cqrs',
              'phase-5-api',
              'phase-6-jobs',
              'phase-7-migration',
              'phase-8-polish'
            ];

            for (const phase of phases) {
              const { data: phaseIssues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                labels: phase,
                per_page: 100
              });

              const total = phaseIssues.filter(i => !i.pull_request).length;
              const closed = phaseIssues.filter(i => i.state === 'closed' && !i.pull_request).length;
              const percentage = total > 0 ? Math.round((closed / total) * 100) : 0;

              phaseStats[phase] = { total, closed, percentage };
            }

            // Build report
            let report = `# ðŸ“Š Daily Progress Report - ${today.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}\n\n`;

            report += `## ðŸ“ˆ Summary\n\n`;
            report += `| Metric | Count |\n`;
            report += `|--------|-------|\n`;
            report += `| Issues Created | ${created.length} |\n`;
            report += `| Issues Completed | ${completed.length} |\n`;
            report += `| Issues In Progress | ${inProgress.length} |\n`;
            report += `| PRs Created | ${prsCreated.length} |\n`;
            report += `| PRs Merged | ${prsMerged.length} |\n\n`;

            // Phase progress
            report += `## ðŸŽ¯ Phase Progress\n\n`;
            for (const [phase, stats] of Object.entries(phaseStats)) {
              if (stats.total > 0) {
                const phaseName = phase.replace('phase-', 'Phase ').replace(/-/g, ' ');
                const progressBar = 'â–ˆ'.repeat(Math.floor(stats.percentage / 5)) +
                                  'â–‘'.repeat(20 - Math.floor(stats.percentage / 5));
                report += `**${phaseName}**: ${progressBar} ${stats.percentage}% (${stats.closed}/${stats.total})\n`;
              }
            }
            report += `\n`;

            // Completed issues
            if (completed.length > 0) {
              report += `## âœ… Completed Today\n\n`;
              for (const issue of completed) {
                const labels = issue.labels.map(l => l.name).filter(n =>
                  n.startsWith('phase-') || ['ai-task', 'domain', 'application', 'infrastructure'].includes(n)
                );
                report += `- #${issue.number}: ${issue.title}`;
                if (labels.length > 0) {
                  report += ` \`${labels.join('` `')}\``;
                }
                report += `\n`;
              }
              report += `\n`;
            }

            // Created issues
            if (created.length > 0) {
              report += `## ðŸ†• Created Today\n\n`;
              for (const issue of created) {
                report += `- #${issue.number}: ${issue.title}\n`;
              }
              report += `\n`;
            }

            // In progress
            if (inProgress.length > 0) {
              report += `## ðŸ—ï¸ In Progress\n\n`;
              for (const issue of inProgress) {
                const assignee = issue.assignee ? `@${issue.assignee.login}` : 'Unassigned';
                report += `- #${issue.number}: ${issue.title} (${assignee})\n`;
              }
              report += `\n`;
            }

            // Merged PRs
            if (prsMerged.length > 0) {
              report += `## ðŸ”€ PRs Merged Today\n\n`;
              for (const pr of prsMerged) {
                report += `- #${pr.number}: ${pr.title} by @${pr.user.login}\n`;
              }
              report += `\n`;
            }

            // Get blocked issues
            const { data: blockedIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'blocked',
              per_page: 50
            });

            if (blockedIssues.filter(i => !i.pull_request).length > 0) {
              report += `## ðŸš« Blocked Issues\n\n`;
              for (const issue of blockedIssues.filter(i => !i.pull_request)) {
                report += `- #${issue.number}: ${issue.title}\n`;
              }
              report += `\n`;
            }

            report += `---\n`;
            report += `*Generated automatically by GitHub Actions*\n`;
            report += `*Next report: ${new Date(Date.now() + 24*60*60*1000).toLocaleDateString()}*`;

            // Create issue with report
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Daily Progress Report - ${today.toLocaleDateString()}`,
              body: report,
              labels: ['report', 'documentation']
            });

            console.log('Progress report created successfully');
